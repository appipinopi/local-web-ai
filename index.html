<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>All-in-One Browser AI</title>
    <style>
        /* --- デザイン設定 --- */
        body { background-color: #050505; color: #00ff41; font-family: 'Courier New', monospace; margin: 0; padding: 20px; }
        h1 { border-bottom: 1px solid #00ff41; padding-bottom: 10px; text-transform: uppercase; }
        
        .container { display: flex; gap: 20px; height: 85vh; }
        .panel { flex: 1; border: 1px solid #333; padding: 15px; display: flex; flex-direction: column; background: #111; }
        
        /* 入力・ボタン */
        input[type="text"], textarea { background: #000; color: #fff; border: 1px solid #006600; padding: 10px; font-family: inherit; }
        input[type="text"] { width: 70%; }
        
        button { background: #003300; color: #00ff41; border: 1px solid #00ff41; padding: 10px; cursor: pointer; font-weight: bold; margin-left: 5px; }
        button:hover { background: #00ff41; color: #000; }
        button:disabled { background: #333; color: #555; border-color: #555; cursor: not-allowed; }

        /* ログ・表示エリア */
        #statusLog { height: 150px; overflow-y: auto; border: 1px solid #333; padding: 5px; margin-top: 10px; font-size: 12px; color: #aaa; }
        #chatLog { flex: 1; overflow-y: auto; border: 1px solid #333; padding: 10px; margin-bottom: 10px; white-space: pre-wrap; }
        
        .ai-msg { color: #00ff41; margin-bottom: 8px; border-left: 2px solid #00ff41; padding-left: 10px; }
        .user-msg { color: #fff; margin-bottom: 8px; text-align: right; }
        
        /* データ量表示 */
        .stats { font-size: 12px; color: #666; margin-top: 5px; text-align: right; }
    </style>
</head>
<body>

<h1>Unlimited AI - Web Crawler Edition</h1>

<div class="container">
    <div class="panel">
        <h3>1. 知識の吸収 (Crawl & Learn)</h3>
        <div>
            <input type="text" id="targetUrl" placeholder="https://ja.wikipedia.org/wiki/...">
            <button id="btnStart" onclick="startCrawling()">収集開始</button>
        </div>
        <div class="stats">読み込むページ上限: <span id="pageLimit">20</span> | 収集済みパターン数: <span id="brainSize">0</span></div>
        
        <div id="statusLog">ログ待機中...</div>

        <hr style="width:100%; border-color:#333; margin: 15px 0;">
        
        <h3>脳の管理</h3>
        <button onclick="downloadJson()">脳データを保存 (Save JSON)</button>
        <input type="file" id="fileInput" style="display:none" onchange="loadJson(this)">
        <button onclick="document.getElementById('fileInput').click()">脳データを読込 (Load JSON)</button>
    </div>

    <div class="panel">
        <h3>2. 対話 (Interaction)</h3>
        <div id="chatLog"></div>
        <div style="display: flex;">
            <input type="text" id="userInput" placeholder="きっかけの言葉" style="flex:1;">
            <button onclick="generateText()">生成</button>
        </div>
    </div>
</div>

<script>
    // --- AIの設定 ---
    const ORDER = 3; // 何文字セットで覚えるか
    let brain = {};  // AIの脳みそ
    
    // --- クローラーの設定 ---
    const MAX_PAGES = 20; // ブラウザが重くならないよう制限（増やしても良いが自己責任）
    let visitedUrls = new Set();
    let urlQueue = [];
    let isCrawling = false;

    // ログ表示用
    function log(msg) {
        const div = document.getElementById('statusLog');
        div.innerHTML += `<div>> ${msg}</div>`;
        div.scrollTop = div.scrollHeight;
    }

    // --- 1. Webクローラー機能 (CORS回避版) ---
    async function startCrawling() {
        const startUrl = document.getElementById('targetUrl').value;
        if (!startUrl) return alert("URLを入力してください");
        if (isCrawling) return;

        isCrawling = true;
        document.getElementById('btnStart').disabled = true;
        visitedUrls.clear();
        urlQueue = [startUrl];
        let pageCount = 0;

        // ドメイン制限用（他サイトへ飛んでいかないようにする）
        const baseDomain = new URL(startUrl).hostname;

        log(`収集開始: ${startUrl}`);

        while (urlQueue.length > 0 && pageCount < MAX_PAGES) {
            const currentUrl = urlQueue.shift();
            
            if (visitedUrls.has(currentUrl)) continue;
            visitedUrls.add(currentUrl);

            try {
                log(`[${pageCount + 1}/${MAX_PAGES}] 読込中: ${currentUrl}`);
                
                // プロキシ経由でHTMLを取得 (AllOrigins APIを使用)
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(currentUrl)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                
                if (!data.contents) throw new Error("データ取得失敗");

                // 仮想DOMを作ってHTMLを解析
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');

                // 不要なタグ（スクリプト等）を削除
                const scripts = doc.querySelectorAll('script, style, noscript, iframe');
                scripts.forEach(el => el.remove());

                // テキストを抽出して学習
                const text = doc.body.textContent || "";
                trainBrain(text);

                // ページ内のリンクを抽出してキューに追加
                const links = doc.querySelectorAll('a');
                links.forEach(a => {
                    try {
                        // 相対パスを絶対パスに直す（簡易処理）
                        const href = new URL(a.getAttribute('href'), currentUrl).href;
                        if (href.includes(baseDomain) && !visitedUrls.has(href)) {
                            urlQueue.push(href);
                        }
                    } catch(e) {}
                });

                pageCount++;
                // サーバー負荷軽減のため少し待つ（ブロッキングではないが擬似的に）
                await new Promise(r => setTimeout(r, 500));

            } catch (err) {
                log(`エラー: ${err.message}`);
            }
        }

        log("--- 収集完了 ---");
        isCrawling = false;
        document.getElementById('btnStart').disabled = false;
        alert("データ収集が完了しました！右側のパネルで会話できます。");
    }

    // --- 2. 学習ロジック (Markov Chain) ---
    function trainBrain(text) {
        // 空白整理
        text = text.replace(/\s+/g, ' ').trim();
        if (text.length < ORDER) return;

        let count = 0;
        for (let i = 0; i < text.length - ORDER; i++) {
            const gram = text.substring(i, i + ORDER);
            const nextChar = text.charAt(i + ORDER);

            if (!brain[gram]) {
                brain[gram] = [];
            }
            brain[gram].push(nextChar);
            count++;
        }
        document.getElementById('brainSize').innerText = Object.keys(brain).length;
    }

    // --- 3. 生成ロジック (Generation) ---
    function generateText() {
        const seed = document.getElementById('userInput').value;
        
        // 脳が空っぽの場合
        const keys = Object.keys(brain);
        if (keys.length === 0) return alert("まずはURLを入れて学習させてください！");

        let currentGram = seed.slice(-ORDER);
        
        // 脳にない言葉、または空欄ならランダムに開始
        if (!brain[currentGram]) {
            currentGram = keys[Math.floor(Math.random() * keys.length)];
        }

        let result = seed ? seed : currentGram;
        
        // 文章生成ループ
        for (let i = 0; i < 150; i++) {
            const possibilities = brain[currentGram];
            if (!possibilities) break; // 行き止まり

            const nextChar = possibilities[Math.floor(Math.random() * possibilities.length)];
            result += nextChar;
            currentGram = result.slice(-ORDER);
        }

        const logDiv = document.getElementById('chatLog');
        logDiv.innerHTML += `<div class="user-msg">> ${seed}</div>`;
        logDiv.innerHTML += `<div class="ai-msg">${result}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // --- ユーティリティ ---
    function downloadJson() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(brain));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = "ai_brain_web.json";
        a.click();
    }

    function loadJson(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            brain = JSON.parse(e.target.result);
            document.getElementById('brainSize').innerText = Object.keys(brain).length;
            alert("脳データを復元しました");
        };
        reader.readAsText(file);
    }
</script>

</body>
</html>
