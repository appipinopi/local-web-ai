<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Unrestricted AI v0.0.4</title>
    <style>
        /* --- デザイン設定 (Cyber Dark) --- */
        body { background-color: #050505; color: #00ff41; font-family: 'Courier New', monospace; margin: 0; padding: 20px; overflow: hidden; }
        h1 { border-bottom: 1px solid #00ff41; padding-bottom: 5px; font-size: 18px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        /* --- レイアウト --- */
        .container { display: flex; gap: 15px; height: 88vh; }
        .panel { flex: 1; border: 1px solid #333; padding: 10px; display: flex; flex-direction: column; background: #111; }
        
        /* --- UIパーツ --- */
        input[type="text"], textarea { background: #000; color: #fff; border: 1px solid #006600; padding: 8px; font-family: inherit; width: 100%; box-sizing: border-box; }
        textarea { resize: none; height: 80px; font-size: 11px; }
        
        button { background: #003300; color: #00ff41; border: 1px solid #00ff41; padding: 5px 10px; cursor: pointer; font-weight: bold; margin-top: 5px; transition: 0.2s; font-size: 12px; }
        button:hover { background: #00ff41; color: #000; }
        button:disabled { background: #222; color: #555; border-color: #444; cursor: not-allowed; }
        
        .stop-btn { border-color: #ff3333; color: #ff3333; background: #220000; }
        .stop-btn:hover { background: #ff3333; color: #fff; }
        
        .danger-btn { border-color: #ff9900; color: #ff9900; margin-left: auto; }

        /* --- 学習セクションの区切り --- */
        .learning-section { border: 1px solid #222; padding: 8px; margin-bottom: 10px; background: #0a0a0a; }
        .section-title { font-size: 12px; color: #aaa; margin-bottom: 5px; border-bottom: 1px dashed #333; padding-bottom: 2px; font-weight: bold; }

        /* --- ログ・表示エリア --- */
        #statusLog { height: 80px; overflow-y: auto; border: 1px solid #333; padding: 5px; font-size: 10px; color: #888; background: #000; margin-bottom: 10px; }
        #chatLog { flex: 1; overflow-y: auto; border: 1px solid #333; padding: 10px; margin-bottom: 10px; white-space: pre-wrap; background: #080808; }
        
        .ai-msg { color: #00ff41; margin-bottom: 8px; border-left: 2px solid #00ff41; padding-left: 10px; }
        .user-msg { color: #fff; margin-bottom: 8px; text-align: right; }
        
        /* --- スイッチ --- */
        .toggle-label { display: flex; align-items: center; font-size: 12px; color: #fff; margin-top: 5px; cursor: pointer; }
        .toggle-label input { margin-right: 5px; }

        /* --- モーダル --- */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(5px); }
        .modal-box { border: 2px solid #ff3333; background: #110000; padding: 30px; text-align: center; max-width: 500px; color: #ffcccc; box-shadow: 0 0 20px rgba(255, 0, 0, 0.3); }
        .agree-btn { background: #ff3333; color: #000; border: none; padding: 15px 30px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .agree-btn:hover { background: #fff; color: #ff0000; }
    </style>
</head>
<body>

<div id="overlay">
    <div class="modal-box">
        <h2 style="color:#ff3333; margin-top:0;">UNRESTRICTED AI v0.0.4</h2>
        <p style="font-size:13px; text-align:left;">
            このシステムは、入力されたあらゆるデータ（URL、テキスト、会話）を無差別に学習します。<br>
            倫理的なフィルターや安全装置はありません。<br><br>
            【注意】<br>
            ページを閉じると学習データは消滅します。<br>
            必要な場合はJSON保存機能を使用してください。
        </p>
        <button class="agree-btn" onclick="acceptTerms()">システム起動</button>
    </div>
</div>

<h1>
    <span>AI v0.0.4 [Multi-Input]</span>
    <span style="font-size:12px; color:#666;">Patterns: <span id="brainSize" style="color:#fff;">0</span></span>
</h1>

<div class="container">
    <div class="panel" style="flex: 0 0 40%;">
        <div class="learning-section">
            <div class="section-title">1. Web Crawler (URL)</div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="targetUrl" placeholder="https://...">
                <button id="btnStart" onclick="startCrawling()">開始</button>
                <button id="btnStop" class="stop-btn" onclick="stopCrawling()" disabled>停止</button>
            </div>
            <div style="font-size:10px; text-align:right; color:#555; margin-top:2px;">Page Limit: 30</div>
        </div>

        <div class="learning-section">
            <div class="section-title">2. Direct Injection (Text/File)</div>
            <textarea id="manualText" placeholder="ここに文章を貼り付けて「学習」を押すか、.txtファイルを読み込んでください"></textarea>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <button onclick="learnManualText()" style="flex:1;">テキスト学習</button>
                <input type="file" id="txtFileInput" style="display:none" accept=".txt" onchange="loadTxtFile(this)">
                <button onclick="document.getElementById('txtFileInput').click()" style="flex:1;">.txt 読込</button>
            </div>
        </div>

        <div id="statusLog">待機中...</div>

        <div class="learning-section" style="margin-top:auto;">
            <div class="section-title">Memory Management</div>
            <div style="display:flex; gap:5px;">
                <button onclick="downloadJson()" style="flex:1;">JSON保存</button>
                <input type="file" id="jsonFileInput" style="display:none" onchange="loadJsonFile(this)">
                <button onclick="document.getElementById('jsonFileInput').click()" style="flex:1;">JSON読込</button>
                <button class="danger-btn" onclick="clearMemory()">全消去</button>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="section-title">Chat Interface</div>
        <div id="chatLog"></div>
        
        <label class="toggle-label">
            <input type="checkbox" id="chatLearnToggle">
            <span>3. 会話から学習する (Real-time Learning)</span>
        </label>

        <div style="display: flex; margin-top:5px; gap:5px;">
            <input type="text" id="userInput" placeholder="話しかける / きっかけの言葉">
            <button onclick="generateText()" style="width: 80px;">送信</button>
        </div>
    </div>
</div>

<script>
    // --- AI Core ---
    const ORDER = 3; 
    let brain = {};  
    
    // --- Variables ---
    const MAX_PAGES = 30; 
    let visitedUrls = new Set();
    let urlQueue = [];
    let isCrawling = false;
    let stopRequested = false;

    // --- Init ---
    function acceptTerms() {
        document.getElementById('overlay').style.display = 'none';
        log("システム起動完了。学習ソースを選択してください。");
    }

    function log(msg) {
        const div = document.getElementById('statusLog');
        div.innerHTML += `<div>> ${msg}</div>`;
        div.scrollTop = div.scrollHeight;
    }

    // --- Common: 学習関数 ---
    function trainBrain(text, sourceName = "Unknown") {
        if (!text) return;
        text = text.replace(/\s+/g, ' ').trim();
        if (text.length < ORDER) return;

        let newPatterns = 0;
        for (let i = 0; i < text.length - ORDER; i++) {
            const gram = text.substring(i, i + ORDER);
            const nextChar = text.charAt(i + ORDER);
            if (!brain[gram]) brain[gram] = [];
            brain[gram].push(nextChar);
            newPatterns++;
        }
        updateStats();
        // ログが流れすぎないように制御
        if(sourceName !== "Chat") {
            log(`${sourceName}: ${text.length}文字を消化しました`);
        }
    }

    function updateStats() {
        document.getElementById('brainSize').innerText = Object.keys(brain).length;
    }

    // --- Source 1: URL Crawler ---
    async function startCrawling() {
        const startUrl = document.getElementById('targetUrl').value;
        if (!startUrl) return alert("URLを入力してください");
        if (isCrawling) return;

        isCrawling = true; stopRequested = false;
        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnStop').disabled = false;

        visitedUrls.clear(); urlQueue = [startUrl];
        let pageCount = 0;
        const baseDomain = new URL(startUrl).hostname;

        log(`Crawler開始: ${startUrl}`);

        while (urlQueue.length > 0 && pageCount < MAX_PAGES) {
            if (stopRequested) { log("Crawler停止"); break; }

            const currentUrl = urlQueue.shift();
            if (visitedUrls.has(currentUrl)) continue;
            visitedUrls.add(currentUrl);

            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(currentUrl)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                if (!data.contents) throw new Error("No Data");

                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');
                doc.querySelectorAll('script, style, noscript, iframe').forEach(el => el.remove());

                const text = doc.body.textContent || "";
                trainBrain(text, `Page ${pageCount+1}`);

                doc.querySelectorAll('a').forEach(a => {
                    try {
                        const href = new URL(a.getAttribute('href'), currentUrl).href;
                        if (href.includes(baseDomain) && !visitedUrls.has(href)) urlQueue.push(href);
                    } catch(e) {}
                });
                pageCount++;
                await new Promise(r => setTimeout(r, 500));
            } catch (err) { }
        }
        isCrawling = false;
        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnStop').disabled = true;
    }

    function stopCrawling() { if (isCrawling) stopRequested = true; }

    // --- Source 2: Text & File ---
    function learnManualText() {
        const text = document.getElementById('manualText').value;
        if (!text) return alert("テキストエリアが空です");
        trainBrain(text, "Manual Input");
        document.getElementById('manualText').value = ""; // クリア
        alert("学習完了");
    }

    function loadTxtFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            trainBrain(e.target.result, file.name);
            alert(`ファイル ${file.name} を学習しました`);
        };
        reader.readAsText(file); // デフォルトUTF-8
        input.value = ""; // リセット
    }

    // --- Source 3: Chat & Generation ---
    function generateText() {
        const inputEl = document.getElementById('userInput');
        const seed = inputEl.value;
        const isLearningMode = document.getElementById('chatLearnToggle').checked;

        // 会話学習モードなら、ユーザーの発言を学習する
        if (isLearningMode && seed) {
            trainBrain(seed, "Chat");
        }

        const keys = Object.keys(brain);
        if (keys.length === 0) return alert("脳が空っぽです。何か学習させてください。");

        let currentGram = seed.slice(-ORDER);
        if (!brain[currentGram]) {
            currentGram = keys[Math.floor(Math.random() * keys.length)];
        }

        let result = seed ? seed : currentGram;
        
        for (let i = 0; i < 150; i++) {
            const possibilities = brain[currentGram];
            if (!possibilities) break;
            const nextChar = possibilities[Math.floor(Math.random() * possibilities.length)];
            result += nextChar;
            currentGram = result.slice(-ORDER);
        }

        const logDiv = document.getElementById('chatLog');
        
        // ユーザーの吹き出し
        let userLabel = isLearningMode ? "[User (Learned)]" : "[User]";
        logDiv.innerHTML += `<div class="user-msg"><span style="font-size:10px; color:#666;">${userLabel}</span><br>${seed}</div>`;
        
        // AIの吹き出し
        logDiv.innerHTML += `<div class="ai-msg">${result}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        
        inputEl.value = ""; // 入力欄クリア
    }

    // --- Memory Management ---
    function downloadJson() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(brain));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = "ai_brain_v4.json";
        a.click();
    }
    function loadJsonFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            brain = JSON.parse(e.target.result);
            updateStats();
            log("JSONメモリを復元しました");
        };
        reader.readAsText(file);
        input.value = "";
    }
    function clearMemory() {
        if(confirm("全学習データを消去しますか？")) {
            brain = {}; updateStats(); log("メモリ初期化完了");
        }
    }
</script>
</body>
</html>
